#summary Asynchronous network calls with AndroidQuery

<wiki:gadget url="http://android-query.googlecode.com/svn/trunk/demo/gadget/social.xml?v=2" height="115" width="700" border="0" /> 

= Asynchronous Network =

== Permission==

Make sure the following permission is included in your manifest.


== Code ==

Asynchronous AJAX or RPC calls are simple with AQuery.


{{{
<uses-permission android:name="android.permission.INTERNET" /> 
}}}

==== Supported Types ====

AQuery transform the data automatically base on the class type passed in the ajax method.

Supported types:
  * JSONObject
  * JSONArray
  * String (HTML, XML)
  * XmlDom (XML parsing)
  * byte array
  * User defined custom type (Transformer) 
  * [http://code.google.com/p/android-query/wiki/ImageLoading Bitmap]

If there are native Android data types (without third party dependency) you want AQuery to support, please send us feedback.

==== JSON ====
{{{


public void asyncJson(){
	
	//perform a Google search in just a few lines of code
	
	String url = "http://www.google.com/uds/GnewsSearch?q=Obama&v=1.0";
	
	aq.ajax(url, JSONObject.class, new AjaxCallback<JSONObject>() {

		@Override
		public void callback(String url, JSONObject json, AjaxStatus status) {
			
			
			if(json != null){
				
				//successful ajax call, show status code and json content
				Toast.makeText(aq.getContext(), status.getCode() + ":" + json.toString(), Toast.LENGTH_LONG).show();
			
			}else{
				
				//ajax error, show error code
				Toast.makeText(aq.getContext(), "Error:" + status.getCode(), Toast.LENGTH_LONG).show();
			}
		}
	});
	
}

}}}

====JSON (activity as callback) ====
{{{
public void asyncJson(){
	
	//perform a Google search in just a few lines of code
	
	String url = "http://www.google.com/uds/GnewsSearch?q=Obama&v=1.0";		
	aq.ajax(url, JSONObject.class, this, "jsonCallback");
	
}

public void jsonCallback(String url, JSONObject json, AjaxStatus status){
	
	if(json != null){		
		//successful ajax call		
	}else{		
		//ajax error
	}
	
}

}}}

Note that AQuery uses a weak reference to hold the handler for this method. This is to make sure an activity won't be memory leaked when it's terminated before the AJAX request finishes.

==== HTML/XML ====

{{{
//fetch Google's homepage in html

String url = "http://www.google.com";

aq.ajax(url, String.class, new AjaxCallback<String>() {

	@Override
	public void callback(String url, String html, AjaxStatus status) {
		
	}
	
});
}}}

==== XML ====

AQuery provide a light weight XML parser called XmlDom. [http://android-query.googlecode.com/svn/trunk/javadoc/index.html?com/androidquery/util/XmlDom.html javadoc] 

XmlDom is a specialized class for simple and easy XML parsing. It's designed to be used in basic Android api 4+ runtime without any dependency.

Example to parse Picasa's featured photos feed:

{{{
public void xml_ajax(){		
	String url = "https://picasaweb.google.com/data/feed/base/featured?max-results=8";		
	aq.ajax(url, XmlDom.class, this, "picasaCb");		
}

public void picasaCb(String url, XmlDom xml, AjaxStatus status){

	List<XmlDom> entries = xml.tags("entry");		
	List<String> titles = new ArrayList<String>();
	
	String imageUrl = null;
	
	for(XmlDom entry: entries){
		titles.add(entry.text("title"));
		imageUrl = entry.tag("content", "type", "image/jpeg").attr("src");
	}
		
	aq.id(R.id.image).image(imageUrl);
	
}

}}}

Related Blog: [http://blog.androidquery.com/2011/09/simpler-and-easier-xml-parsing-in.html XML Parsing]

==== bytes ====

{{{
//fetch a remote resource in raw bytes

String url = "http://www.vikispot.com/z/images/vikispot/android-w.png";

aq.ajax(url, byte[].class, new AjaxCallback<byte[]>() {

	@Override
	public void callback(String url, byte[] object, AjaxStatus status) {
		Toast.makeText(aq.getContext(), "bytes array:" + object.length, Toast.LENGTH_LONG).show();
	}
});
}}}

====Custom Type====

AQuery by default supports types that are native to Android. For app specific data types, you can assign a custom Transformer to the ajax call and convert the raw data to a desired type. The benefit of transformer is that it's run under the background thread (similar to the natively supported types), therefore minimizing CPU cycles and avoid blocking on the UI thread.

This example show how to use Gson to transform raw data to user defined types.

{{{
private static class Profile{
	public String id;
	public String name;		
}

private static class GsonTransformer implements Transformer{

	public <T> T transform(String url, Class<T> type, String encoding, byte[] data, AjaxStatus status) {			
		Gson g = new Gson();
		return g.fromJson(new String(data), type);
	}
}

public void async_transformer(){
	
	String url = "https://graph.facebook.com/205050232863343";		
	GsonTransformer t = new GsonTransformer();
	
	aq.transformer(t).progress(R.id.progress).ajax(url, Profile.class, new AjaxCallback<Profile>(){			
		public void callback(String url, Profile profile, AjaxStatus status) {	
			Gson gson = new Gson();
			showResult("GSON Object:" + gson.toJson(profile), status);		
		}			
	});
    
}


}}}

====Custom Type (Static Transformer)====

A stateless static default transformer can also be set with AjaxCallback.setTransformer().

Transformers are selected in the following priority:
  # Native
  # instance transformer()
  # static setTransformer()

{{{

//set the static transformer when application starts
GsonTransformer t = new GsonTransformer();
AjaxCallback.setTransformer(t);

//any subsequent ajax calls will use the static transformer for custom types
String url = "https://graph.facebook.com/205050232863343";
aq.ajax(url, Profile.class, this, "callback");

}}}

=== Http POST ===

{{{
public void async_post(){
	
    //do a twiiter search with a http post
	
    String url = "http://search.twitter.com/search.json";
	
    Map<String, Object> params = new HashMap<String, Object>();
    params.put("q", "androidquery");
	
    aq.ajax(url, params, JSONObject.class, new AjaxCallback<JSONObject>() {

        @Override
        public void callback(String url, JSONObject json, AjaxStatus status) {
               
            showResult(json);
           
        }
    });
	
}

}}}

=== Http POST (Multipart) ===

AQuery support multipart post such as uploading an image to a service. Simply do a regular POST and put byte[] or File as one of the parameters.

{{{
private void aync_multipart(){
	
	String url = "https://graph.facebook.com/me/photos";
	
	Map<String, Object> params = new HashMap<String, Object>();
	params.put("message", "Message");
	
	//Simply put a byte[] to the params, AQuery will detect it and treat it as a multi-part post
	byte[] data = getImageData();
	params.put("source", data);
	
	//Alternatively, put a file instead of byte[]
	//File file = getImageFile();		
	//params.put("source", file);
	
	AQuery aq = new AQuery(getApplicationContext());
	aq.auth(handle).ajax(url, params, JSONObject.class, this, "photoCb");
	
}

}}}

=== Http POST (Custom Entity)===

If a custom entity is required, you can use the special AQuery.POST_ENTITY key name to pass in an HttpEntity object.

{{{

public void async_post_entity() throws UnsupportedEncodingException{
	
    String url = "http://search.twitter.com/search.json";
	
    List<NameValuePair> pairs = new ArrayList<NameValuePair>();
	pairs.add(new BasicNameValuePair("q", "androidquery"));				
	HttpEntity entity = new UrlEncodedFormEntity(pairs, "UTF-8");
    
	Map<String, Object> params = new HashMap<String, Object>();
	params.put(AQuery.POST_ENTITY, entity);
    
    aq.progress(R.id.progress).ajax(url, params, JSONObject.class, new AjaxCallback<JSONObject>() {

        @Override
        public void callback(String url, JSONObject json, AjaxStatus status) {
            
            showResult(json, status);
           
        }
    });
}

}}}

=== Caching ===

Caching is easy with ajax requests. Just pass in an expire time as a parameter, and if the data is available, it will be served from the file cache instead of fetching over the network.

{{{

String url = "http://www.google.com";

//return a cached copy if the data is recently fetched within 15 minutes 
long expire = 15 * 60 * 1000;

aq.ajax(url, String.class, expire, new AjaxCallback<String>() {

    @Override
    public void callback(String url, String html, AjaxStatus status) {        
    	showResult(html);
    }
        
});


}}}

=== Invalidating Cache ===

Calling the invalidate method of the AjaxStatus object will invalidate the url content so that it will not be cached. It's useful when http status is 200 but the object returned is invalid.

{{{

public void callback(String url, JSONObject json, AjaxStatus status) {
    
	if(json != null){
		if("1".equals(json.optString("status"))){
			//do something
		}else{
			//we believe the request is a failure, don't cache it
			status.invalidate();
		}
	}
}

}}}


=== Progress ===

We can show the loading progress by using the progress() method. Pass in the progress bar id, or any other view id to the progress method, and the view will be shown or hide to display ajax progress.

{{{

String url = "http://www.google.com/uds/GnewsSearch?q=Obama&v=1.0";                
aq.progress(R.id.progress).ajax(url, JSONObject.class, this, "jsonCb");

}}}

=== Activity Finished Detection===

AQuery will examine the initialization context and skip the ajax callback if an activity is already stopped before the aync task is completed. This behavior avoid unnecessary work and avoid modifying ui states that could be illegal (such as showing a dialog when an activity is not longer active).

{{{

//using the activity as context will ensure no callback is called when activity is finished
AQuery aq = new AQuery(activity);

//using the application context will ensure the callback to be called as long as the application is running
AQuery aq = new AQuery(getApplicationContext());

}}}

=== Synchronous Call (Block)===

If the ajax call is run outside of main thread, the sync() method can be used to block the calling thread until the ajax call is completed (or until it's timed out).

Fetch result synchronously:

{{{

String url = "http://www.google.com/uds/GnewsSearch?q=Obama&v=1.0";
        
AjaxCallback<JSONObject> cb = new AjaxCallback<JSONObject>();		
cb.url(url).type(JSONObject.class);		
        
aq.sync(cb);
        
JSONObject jo = cb.getResult();
AjaxStatus status = cb.getStatus();

}}}

Note that this will block the thread until the result is returned. The actual work will be done in another thread pool. Calling this method in Main/UI thread will caused an exception.

=== Ajax Status ===

An AjaxStatus object is returned with any callback. This object holds some meta information regarding the aync task performed.

{{{
public void callback(String url, JSONObject json, AjaxStatus status) {
    
    int source = status.getSource();
    int responseCode = status.getCode();
    long duration = status.getDuration();
    Date fetchedTime = status.getTime();
    String message = status.getMessage();
    String redirect = status.getRedirect();
    DefaultHttpClient client = status.getClient();
	
}

}}}

[http://android-query.googlecode.com/svn/trunk/javadoc/index.html?com/androidquery/AbstractAQuery.html javadoc]

=== Advance ===

The AQuery object provide various commonly used "ajax" methods. For more advanced (but less commonly used) features such as http header and authentication, AjaxCallback can be used directly to customize the requests.

Note: url and type are required parameters.

{{{

String url = "http://www.google.com/uds/GnewsSearch?q=Obama&v=1.0";

AjaxCallback<JSONObject> cb = new AjaxCallback<JSONObject>();        
cb.url(url).type(JSONObject.class).weakHandler(this, "jsonCb").fileCache(true).expire(0);

aq.ajax(cb);

}}}

=== Http Headers ===

Use the header method to configure http request headers.

{{{

String url = "http://www.google.com";

AjaxCallback<String> cb = new AjaxCallback<String>();        
cb.url(url).type(String.class).weakHandler(this, "stringCb");

cb.header("Referer", "http://code.google.com/p/android-query/");
cb.header("User-Agent", "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:6.0.2) Gecko/20100101 Firefox/6.0.2");

aq.ajax(cb);

}}}

=== Encoding ===

The default ajax callback uses UTF-8 to transform the object. If custom encoding is needed, uses the encoding() method for the AkaxCallback.

{{{
String url = "http://www.kyotojp.com/limousine-big5.html";

AjaxCallback<String> cb = new AjaxCallback<String>();
cb.url(url).type(String.class).encoding("Big5").weakHandler(this, "encodingCb");

aq.ajax(cb);

}}}

== Maintenance==

AQuery provides few utility functions to help you control ajax and caching behavior.

=== Cancel ===

{{{
public void onDestroy(){
	
	//stop all async calls when current activity is exiting
	AjaxCallback.cancel();
	
}
}}}